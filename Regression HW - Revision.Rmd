---
title: "Regression Homework Revision"
author: "Scott Sun"
date: "2/22/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("https://github.com/reyesem/reyesem.github.io/raw/master/files/MA483/MA483Setup.R")
options(mc.cores = 3)
```

## Revision on Problem 2, 10, 12
### Problem 2
Based on the residual vs. fitted plot, points deviate from the 0 horizontal line systematically. Therefore, the errors do not have mean of 0. This implies that the response do not have linear relationship with the predictor; instead, the relationship might be cubic or at a higher order.

### Problem 10

```{r}
data("airquality")
airquality <- filter(airquality, !is.na(Ozone),
                                 !is.na(Wind),
                                 !is.na(Temp))
```

According to the context, assume a model as follows.
$$
\begin{aligned}
(Ozone)_i &\sim t(\nu, \mu, \sigma) \\
\mu &= \beta_0 + \beta_1(Wind)_i + \beta_2(Temp)_i, \text{where}~\beta_j \sim 1 \\
\sigma &\sim 1 \\
(\nu-1) &\sim Exp(1)
\end{aligned}
$$

```{stan output.var="StanAir", eval=FALSE}
data{
  int<lower = 0> N;
  int<lower = 0> p;
  vector[N] Ozone;
  matrix[N, p] X;
}

transformed data{
  matrix[N, p] Qstar;
  matrix[p, p] Rstar;
  matrix[p, p] RstarInv;
  
  Qstar = qr_Q(X)[, 1:p] * sqrt(N - 1);
  Rstar = qr_R(X)[1:p, ] / sqrt(N - 1);
  RstarInv = inverse(Rstar);
}

parameters{
  real beta0;
  vector[p] theta;      // scaled coefficients
  real<lower = 0> sigma;
  real<lower = 1> nu;
}

model{
  real nuMinusOne;
  nuMinusOne = nu - 1;
  nuMinusOne ~ exponential(1);
  Ozone ~ student_t(nu, Qstar*theta + beta0, sigma);
}

generated quantities{
  vector[p] beta;
  beta = RstarInv * theta; // actual coefficients
}
```

```{r, eval=FALSE}
saveRDS(StanAir, "StanAir.rds")
```

```{r}
StanAir <- readRDS("StanAir.rds")
```

```{r}
dataList.air <- list(N = nrow(airquality),
                     p = 2,
                     Ozone = airquality$Ozone,
                     X = cbind(airquality$Wind,
                               airquality$Temp))
fit.air <- stan(model_code = StanAir@model_code,
                data = dataList.air)
fit.air
```

```{r}
beta_hat <- as.data.frame(fit.air) %>%
  select(starts_with("beta")) %>%
  apply(2, median)         ## use posterior median as the estimates for paramters

airquality <- airquality %>%
  mutate(Fitted = beta_hat[1] + beta_hat[2]*Wind + beta_hat[3]*Temp,
         Residuals = Ozone - Fitted)
```

```{r, fig.width=5, fig.asp=0.6}
ggplot(data = airquality,
       aes(x = Fitted, y = Residuals)) +
  geom_point() +
  geom_smooth(method = "loess", formula = y ~ x) +
  labs(x = "Predicted mean ozone reading / ppb",
       y = "Residuals",
       title = "Residuals vs. predicted value") +
  theme_bw()
```

The curve trend implies the assumption of linear relationship is not approprate. Besides, the fan-shape pattern indicates the response has heteroscedasticity, so the assumption of constant variance also fails. Therefore, the model is not appropriate, and we should not rely on the results.

### Problem 12
```{r}
bodyfat <- read.csv("BodyFatPercentage.csv")
```

```{stan output.var="StanBodyfat", eval=FALSE}
data{
 vector[3] a;
 int<lower = 0> N;
 int<lower = 0, upper = 1> Activity[N, 3];
 vector[N] BMI;
 vector[N] Bodyfat;
}

parameters{
  simplex[3] theta;
  real alpha[3];
  real<lower = 0> phi;
  
  vector[5] beta;
  real<lower = 0> sigma;
}

model{
  real eta;
  real mu;
  
  target += dirichlet_lpdf(theta | a);
  target += normal_lpdf(alpha | 22, 4);
  
  for (j in 3:5) {
    target += normal_lpdf(beta[j] | 30, 4);
  }
  
  for (i in 1:N) {
    target += multinomial_lpmf(Activity[i,] | theta);
    eta = alpha[1]*Activity[i,1] + alpha[2]*Activity[i,2] + alpha[3]*Activity[i,3];
    target += normal_lpdf(BMI[i] | eta, phi);
    
    mu = beta[1]*(BMI[i] - mean(BMI)) + beta[2]*(BMI[i] - mean(BMI))^2 +
      beta[3]*Activity[i, 1] + beta[4]*Activity[i, 2] + 
      beta[5]*Activity[i, 3];
    target += normal_lpdf(Bodyfat[i] | mu, sigma);
  }
}

generated quantities{
  real newBMI;
  newBMI = normal_rng(alpha[3], phi);
}
```

```{r, eval=FALSE}
saveRDS(StanBodyfat, "StanBodyfat.rds")
```

```{r}
StanBodyfat <- readRDS("StanBodyfat.rds")
```

```{r}
low <- ifelse(bodyfat$Activity_Level == "low", 1, 0)
medium <- ifelse(bodyfat$Activity_Level == "medium", 1, 0)
high <- ifelse(bodyfat$Activity_Level == "high", 1, 0)

dataList.bodyfat <- list(a = c(1, 1, 1),
                         N = nrow(bodyfat),
                         Activity = cbind(low, medium, high),
                         BMI = bodyfat$BMI,
                         Bodyfat = bodyfat$Percent_Fat)

fit.bodyfat <- stan(model_code = StanBodyfat@model_code,
                    data = dataList.bodyfat,
                    chains = 4)
```

```{r}
fit.bodyfat
```

```{r}
bodyfatParam.df <- as.data.frame(fit.bodyfat)

beta1 <- bodyfatParam.df$`beta[1]`
beta2 <- bodyfatParam.df$`beta[2]`
beta5 <- bodyfatParam.df$`beta[5]`
sigma <- bodyfatParam.df$sigma
newbmi <- bodyfatParam.df$newBMI

mu <- beta1*(newbmi - mean(bodyfat$BMI)) + beta2*(newbmi - mean(bodyfat$BMI))^2 + beta5
```

Therefore, the 95% credible interval of the estimated body fat percentage of a highly active young woman is calculated as follows.
```{r}
rnorm(nrow(bodyfatParam.df), mu, sigma) %>%
  hdi(0.95) %>%
  round(3)
```

